<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kullanıcı Detayı — Yönetim</title>
  <style><%- include('../partials/admin-styles') %>
    .badge-durum { padding:2px 8px;border-radius:9999px;font-size:.75rem;font-weight:600; }
    .durum-paid { background:#dcfce7;color:#166534; }
    .durum-pending { background:#fef9c3;color:#854d0e; }
    .durum-failed,.durum-refunded { background:#fee2e2;color:#991b1b; }
    .bilgi-satir { display:flex;border-bottom:1px solid #f1f5f9;padding:.6rem 0; }
    .bilgi-etiket { width:160px;font-size:.83rem;font-weight:600;color:#64748b;flex-shrink:0; }
    .bilgi-deger { font-size:.88rem;color:#1e293b; }
  </style>
</head>
<body>
  <%- include('../partials/yonetim-nav', { active: 'kullanicilar' }) %>
  <div class="main-content">
    <div class="page-header">
      <div style="display:flex;align-items:center;gap:.75rem">
        <a href="/yonetim/kullanicilar" class="btn btn-ghost btn-sm">← Geri</a>
        <h1 class="page-title">Kullanıcı Detayı</h1>
      </div>
      <% if (hedefKullanici.role === 'ADMIN') { %>
        <span style="background:#f5f3ff;color:#7c3aed;padding:4px 12px;border-radius:9999px;font-size:.8rem;font-weight:700;">ADMIN</span>
      <% } else { %>
        <span style="background:#f0fdf4;color:#166534;padding:4px 12px;border-radius:9999px;font-size:.8rem;font-weight:600;">MÜŞTERİ</span>
      <% } %>
    </div>

    <% if (typeof flash !== 'undefined') { %>
      <% if (flash === 'rol-guncellendi') { %>
        <div style="background:#f0fdf4;color:#166534;border:1px solid #bbf7d0;padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.85rem;">✅ Rol başarıyla güncellendi.</div>
      <% } else if (flash === 'kendi-rol') { %>
        <div style="background:#fef9c3;color:#854d0e;border:1px solid #fde68a;padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.85rem;">⚠️ Kendi rolünüzü değiştiremezsiniz.</div>
      <% } %>
    <% } %>

    <!-- Temel Bilgiler -->
    <div class="card">
      <h2 style="font-size:1rem;font-weight:700;margin-bottom:1rem">Temel Bilgiler</h2>
      <div class="bilgi-satir"><div class="bilgi-etiket">ID</div><div class="bilgi-deger"><code style="font-size:.8rem"><%= hedefKullanici.id %></code></div></div>
      <div class="bilgi-satir"><div class="bilgi-etiket">E-posta</div><div class="bilgi-deger"><%= hedefKullanici.email %></div></div>
      <div class="bilgi-satir"><div class="bilgi-etiket">Rol</div><div class="bilgi-deger"><%= hedefKullanici.role %></div></div>
      <div class="bilgi-satir"><div class="bilgi-etiket">Kayıt Tarihi</div><div class="bilgi-deger"><%= new Date(hedefKullanici.createdAt).toLocaleString('tr-TR') %></div></div>
    </div>

    <!-- Menü Bilgisi -->
    <% if (hedefKullanici.menu) { %>
    <div class="card">
      <h2 style="font-size:1rem;font-weight:700;margin-bottom:1rem">Menü</h2>
      <div class="bilgi-satir"><div class="bilgi-etiket">İşletme Adı</div><div class="bilgi-deger"><strong><%= hedefKullanici.menu.businessName || '—' %></strong></div></div>
      <div class="bilgi-satir"><div class="bilgi-etiket">Slug</div><div class="bilgi-deger"><a href="/m/<%= hedefKullanici.menu.slug %>" target="_blank" style="color:#7c3aed">/m/<%= hedefKullanici.menu.slug %> ↗</a></div></div>
      <div class="bilgi-satir"><div class="bilgi-etiket">Tema</div><div class="bilgi-deger"><%= hedefKullanici.menu.theme?.name || '—' %></div></div>
      <div class="bilgi-satir"><div class="bilgi-etiket">Kategori Sayısı</div><div class="bilgi-deger"><%= hedefKullanici.menu._count?.categories ?? 0 %></div></div>
      <div class="bilgi-satir"><div class="bilgi-etiket">Ürün Sayısı</div><div class="bilgi-deger"><%= hedefKullanici.menu._count?.products ?? 0 %></div></div>
      <div style="margin-top:1rem">
        <a href="/yonetim/menuler/<%= hedefKullanici.menu.id %>" class="btn btn-primary btn-sm">Menüyü Düzenle</a>
      </div>
    </div>
    <% } %>

    <!-- Satın Alımlar -->
    <div class="card">
      <h2 style="font-size:1rem;font-weight:700;margin-bottom:1rem">Satın Alımlar (<%= hedefKullanici.purchases.length %>)</h2>
      <% if (hedefKullanici.purchases.length === 0) { %>
        <p style="color:#94a3b8;font-size:.9rem">Henüz satın alım yok.</p>
      <% } else { %>
        <table class="table">
          <thead><tr><th>Tarih</th><th>Tema</th><th>Tutar</th><th>Durum</th><th>Detay</th></tr></thead>
          <tbody>
            <% hedefKullanici.purchases.forEach(s => { %>
              <tr>
                <td style="font-size:.82rem;color:#64748b"><%= new Date(s.createdAt).toLocaleDateString('tr-TR') %></td>
                <td style="font-size:.85rem"><%= s.theme?.name || '—' %></td>
                <td style="font-size:.85rem;font-weight:600"><%= Number(s.amount).toFixed(2) %> <%= s.currency %></td>
                <td><span class="badge-durum durum-<%= s.status %>"><%= s.status==='paid'?'Ödendi':s.status==='pending'?'Beklemede':s.status==='failed'?'Başarısız':'İptal' %></span></td>
                <td><a href="/yonetim/satin-alimlar/<%= s.id %>" class="btn btn-ghost btn-sm">Detay</a></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- Rol Değiştir -->
    <% if (kullanici.id !== hedefKullanici.id) { %>
    <div class="card" style="border:1px solid #fee2e2">
      <h2 style="font-size:1rem;font-weight:700;margin-bottom:.5rem;color:#991b1b">⚠️ Rol Değiştir</h2>
      <p style="font-size:.85rem;color:#64748b;margin-bottom:1rem">Bu işlem geri alınabilir. Dikkatli olun.</p>
      <form action="/yonetim/kullanicilar/<%= hedefKullanici.id %>/rol" method="POST" style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap"
        onsubmit="return confirm('Rol değiştirilecek. Emin misiniz?')">
        <select name="rol" class="form-control" style="width:auto">
          <option value="MUSTERI" <%= hedefKullanici.role==='MUSTERI'?'selected':'' %>>MÜŞTERİ</option>
          <option value="ADMIN" <%= hedefKullanici.role==='ADMIN'?'selected':'' %>>ADMIN</option>
        </select>
        <button type="submit" class="btn btn-danger btn-sm">Rolü Değiştir</button>
      </form>
    </div>
    <% } %>
  </div>
</body>
</html>
